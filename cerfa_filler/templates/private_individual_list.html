{% extends 'base.html' %}

{% load django_bootstrap5 i18n %}

{% block title %}
  {% translate 'individuals list' %}
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12">
      <div class="m-3">
        <h2>{% translate 'individuals' %}</h2>

        <!-- Formulaire pour la validation des données en masse -->
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-2">
      <!-- Formulaire de filtrage -->
      <form id="filter-form" method="get" action="{% url 'cerfa_filler:private-individual-list' %}">
        {% csrf_token %}
        {% bootstrap_form filterForm %}
        {% bootstrap_button button_type='submit' content="Let's Go!" layout='horizontal' %}
      </form>
    </div>
    <div class="col-10">
      <form id="update-form" method="post" action="{% url 'cerfa_filler:companies-update-valid-date' %}">
        {% csrf_token %}
        <div class="float-end">
          {% if perms.cerfa_filler.add_individuals %}
            <a class="btn btn-primary" href="{% url 'cerfa_filler:private-individual-create' %}">＋ Nouveau</a>
          {% endif %}
          {% if perms.cerfa_filler.change_validation %}
            <button type="submit" form="update-form" class="btn btn-success">✔ Valider</button>
          {% endif %}
        </div>

        <table class="table table-striped">
          <thead>
            <tr>
              {% if perms.cerfa_filler.change_validation %}
                <th>
                  <input type="checkbox" onclick="toggle(this);" />
                </th>
              {% endif %}
              <th onclick="sortTable({% if perms.cerfa_filler.change_validation %}
                  1
                {% else %}
                  0
                {% endif %})">
                DT
              </th>
              <th onclick="sortTable({% if perms.cerfa_filler.change_validation %}
                  2
                {% else %}
                  1
                {% endif %})">
                Numéro d'ordre
              </th>
              <th onclick="sortTable({% if perms.cerfa_filler.change_validation %}
                  3
                {% else %}
                  2
                {% endif %})">
                Nom
              </th>
              <th onclick="sortTable({% if perms.cerfa_filler.change_validation %}
                  4
                {% else %}
                  3
                {% endif %})">
                Total
              </th>
              <th>
                Commentaire
              </th>
              <th onclick="sortTable({% if perms.cerfa_filler.change_validation %}
                  6
                {% else %}
                  5
                {% endif %})">
                Statut
              </th>
              {% if perms.cerfa_filler.change_individuals or perms.cerfa_filler.send_email %}
                <th>
                  Actions
                </th>
              {% endif %}
            </tr>
          </thead>
          <tbody class="table-group-divider">
            {% for individu in individuals %}
              <tr data-bs-toggle="tooltip" data-bs-placement="top" title="{{ individu.metadata }}">
                {% if perms.cerfa_filler.change_validation %}
                  <th>
                    <input type="checkbox" name="selected_individuals" value="{{ individu.uuid }}" />
                  </th>
                {% endif %}
                <td>{{ individu.declarative_structure|default_if_none:'-' }}</td>
                <td data="{{individu.order}}">{{ individu.order_number }}</td>
                <td>{{ individu.full_name }}</td>
                <td data="{{individu.cash_donation}}">{{ individu.cash_donation }} €</td>
                <td>{{ individu.comment|default_if_none:'' }}</td>
                <td>
                  <span class="text-{% if individu.valid_date %}success{% else %}default{% endif %}">
                    {% if individu.valid_date %}
                      ⬤
                    {% else %}
                      ◯
                    {% endif %}
                  </span>
                </td>
                {% if perms.cerfa_filler.change_individuals or perms.cerfa_filler.send_email %}
                  <td>
                    {% if perms.cerfa_filler.change_individuals %}
                      <a href="{% url 'cerfa_filler:private-individual-update' individu.uuid %}" class="btn btn-sm btn-warning">Edit</a>
                    {% endif %}
                    {% if perms.cerfa_filler.send_email and individu.valid_date %}
                      <a href="{% url 'cerfa_filler:private-individual-cerfa-pdf' individu.uuid %}" class="btn btn-sm btn-success">Cerfa</a>
                      <a class="btn btn-sm btn-info" href="{{ individu.mailto }}">Email</a>
                    {% endif %}
                  </td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </form>
    </div>
  </div>
  <script>
    const toggle = (source) => {
      let checkboxes = document.querySelectorAll('input[type="checkbox"]')
      checkboxes.forEach((i) => {
        if (i != source) {
          i.checked = source.checked
        }
      })
    }

    function sortTable(columnIndex) {
      const table = document.querySelector('.table tbody')
      const rows = Array.from(table.rows)
      const sortedRows = rows.sort((a, b) => {
        const isNumeric = a.cells[columnIndex].getAttribute('data') && b.cells[columnIndex].getAttribute('data')
        aValue = a.cells[columnIndex].getAttribute('data') || a.cells[columnIndex].textContent.trim()
        bValue = b.cells[columnIndex].getAttribute('data') || b.cells[columnIndex].textContent.trim()
        return aValue.localeCompare(bValue, undefined, { numeric: isNumeric })
      })
      // Clear the table and append sorted rows
      table.innerHTML = ''
      sortedRows.forEach((row) => table.appendChild(row))
    }
  </script>
{% endblock %}
